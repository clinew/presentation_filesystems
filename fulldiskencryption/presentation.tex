% Thanks to Kevin D. McGrath for the presentation template.
\documentclass[xcolor={dvipsnames,svgnames},hyperref=dvips]{beamer}

% Packages.
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{url}
\usepackage{pstricks}
\usepackage{pst-node}

% Hyperlinks.
\def\name{Wade Cline}
\hypersetup{
  colorlinks = true,
  citecolor = black,
  linkcolor = black,
  urlcolor = black,
  pdfauthor = {\name},
  pdfkeywords = {``computer science'', lug, cryptography, full-disk},
  pdftitle = {Linux Full-Disk Encryption},
  pdfsubject = {Full-Disk Encryption Basics},
  pdfpagemode = UseNone
}

% ???
\usetheme[hideothersubsections]{Hannover}
\usecolortheme{sidebartab}

% Presentation metadata.
\title[Full-Disk Encryption]{}
\author{Wade Cline}
\date{04 March 2014}

\AtBeginSection[]
{
  \begin{frame}<beamer>{Outline}
    \tableofcontents[currentsection]
  \end{frame}
}
\AtBeginSubsection[]
{
  \begin{frame}<beamer>{Outline}
    % \transwipe
    \tableofcontents[currentsection,currentsubsection]
  \end{frame}
}

\begin{document}

% Title.
\begin{frame}
  \titlepage
\end{frame}

% Table of Contents.
\begin{frame}{Outline}
  % \transwipe
  \tableofcontents
  % You might wish to add the option [pausesections]
\end{frame}

\section{Basics}\label{section:basics}
	\subsection{Terminology}
	\begin{frame}
		\frametitle{Plaintext vs. Ciphertext}
		\begin{itemize}
		\item Plaintext: Unencrypted data.
		\item Ciphertext: Encrypted data.
		%TODO: Encryption and Decryption images.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Symmetric Cryptography}
		\begin{itemize}
		\item Same key used to encrypt plaintext and to decrypt ciphertext. 
		\item Useful when only one person needs access to information.
		\item Relevant to today's discussion.
		\item Contrasted with Asymetric Cryptography.
		\item Examples: AES, Blowfish, 3DES, Serpent, Twofish.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Asymetric Cryptography}
		\begin{itemize}
		\item AKA Public-Private Key Cryptography.
		\item Different keys used to encrypt plaintext and to decrypt ciphertext.
		\item Useful when communicating securely between two people.
		\item Contrasted with Symmetric Cryptography.
		\item Example: RSA.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Block vs. Stream Ciphers}
		\begin{itemize}
		\item Block Ciphers operate on larged, fixed-length chunks of bits.
		\item Stream Ciphers encrypt digits one-at-a-time.
		\item Similar to Block vs. Character Devices.
		\item Block Ciphers relevant to today's discussion.
		\end{itemize}
	\end{frame}

	\subsection{Physical Media}
	\begin{frame}
		\frametitle{Disk Layout}
		\begin{itemize}
		\item Linux divides disks into 512-byte sections known as \textit{sectors}.
		\item Filesystem divides read/writes into \textit{blocksize} units (multiple of sector size).
		\item Encrypted on sector-level, though filesystem may do block-level writes.
		\item Block Cipher size $\leq$ Sector size $\leq$ Block size
			\begin{itemize}
			\item Common values: 128 \textit{bits} - 512 \textit{bytes} - 4096 bytes, respectively.
			\end{itemize}
		% TODO: Visualization.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Wear-leveling}
		\begin{itemize}
		\item Attempts to distribute writes evenly across the device.
		\item Helps with device longevity.
		\item Used mostly in USB and SSD devices.
		\item Makes overwriting files difficult.
		\item Emphasizes proactive encryption.
		\end{itemize}
	\end{frame}

\section{Wiping}\label{wiping}
	\begin{frame}
		\frametitle{Naive Wiping}
		\begin{itemize}
		\item Nuke disk \textit{once} with a series of '0's (\texttt{/dev/zero}).
		\item Fast, simple, but leaks data.
		\item Each filesystem has a metaphorical ``fingerprint''.
		\item Labratory forensic analysis may reveal old data (discussed later).
		% TODO: Visualization/examples.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Secure Wiping}
		\begin{itemize}
		\item Use cryptographic-grade pseudo-random numbers.
			\begin{itemize}
			\item \texttt{/dev/urandom} should provide a decent stream.
			\item \texttt{/dev/random} in theory better, but in practice you'd be dead before completion.
			\end{itemize}
		\item Wipe multiple times.
			\begin{itemize}
			\item In theory, proper analysis could reveal previous magnetic states.
			\item Government-``recommended'' is 7 times.
			\end{itemize}
		\item Depending on size of drive and computing power this could take days or weeks.
		\end{itemize}
	\end{frame}

\section{Encryption}\label{section:encryption}
	\subsection{Abstraction}
	\begin{frame}
		\frametitle{Ciphers}
		\begin{itemize}
		\item Transforms a chunk of plaintext into ciphertext.
		\item Support must be enabled in the kernel.
		\item Examples: AES, Serpent, Twofish.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Mode of Operation}
		\begin{itemize}
		\item Recall block ciphers work on fixed-length set of bits.
		\item Recall Linux sector size is 512 \textit{bytes}.
		\item Many of today's block ciphers are 128 \textit{bits}.
		\item A \textit{mode of operation} describes how to repeatedly use a block cipher to encrypt a larger area, such as a sector.
		\item Simply breaking apart reveals patterns in data.
		\item Support must be enabled in the kernel.
		\item Examples: CBC, XTS.
		% TODO: Visualization.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Initialization Vector}
		\begin{itemize}
		\item What is the first block chained with? An \textit{initialization vector}.
		\item Part of the Mode of Operation.
		\item Must appear ``random'' to avoid watermarking.
		\item Example: ESSIV.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Keyfiles}
		\begin{itemize}
		\item Instead of passphrase, use a \textit{keyfile}.
		\item Not limited by human memory, fully-random numbers (\texttt{/dev/random}).
		\item For added protection, encrypt keyfile with passphrase.
			\begin{itemize}
			\item Can also protect against keylogging.
			\end{itemize}
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Salts}
		\begin{itemize}
		\item \textit{Additional} input to passphrase during hashing.
		\item Ensure \textit{uniqueness} of result.
		\item Protects against Rainbow Tables.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Key-stretching}
		\begin{itemize}
		\item Passphrases usually \textit{hashed} before input into algorithm.
		\item Increase number of hashing \textit{rounds} before input (0.5 - 2 seconds-worth).
		\item Slows down brute-force \& dictionary attacks dramatically.
		\end{itemize}
	\end{frame}

	\subsection{Implementation}
	\begin{frame}
		\frametitle{\texttt{cryptsetup}}
		\begin{itemize}
		\item \texttt{cryptsetup} front-end to kernel crypto API.
		\item Rather than ``encrypt'' function, create abstraction layer over device.
		\item Entries go under the \texttt{/dev/mapper} directory.
		\item For example, use \texttt{/dev/mapper/root} to access an encrypted \texttt{/dev/sda}.
			\begin{itemize}
			\item \texttt{/dev/sda} appears as garbage (because it's encrypted) to anyone looking at it.
			\item \texttt{/dev/mapper/root} looks like a normal hard drive.
			\end{itemize}
		\item Look under \texttt{ps} for \texttt{kworker}.
		\item Support must be enabled in the kernel (\texttt{CONFIG\_DM\_CRYPT)}.
		% TODO: Visualization.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{LUKS and \texttt{dm-crypt}}
		\begin{itemize}
		\item Two main modes: LUKS (Linux Unified Key Setup) and ``plain'' \texttt{dm-crypt},
		\item LUKS is feature-rich, \texttt{dm-crypt} is not.
		\item Simplfied: Beginners use LUKS, advanced users \textit{may} wish to use \texttt{dm-crypt}.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{LUKS}
		\begin{itemize}
		\item Creates \textit{LUKS header} metadata on disk.
			\begin{itemize}
			\item One or more key-slots.
			\item Cipher/Mode of Operation.
			\item Encrypted keyfile.
			\item Automatic key-stretching.
			\end{itemize}
		\item Wiping out LUKS header makes disc inaccessible.
		\item Clearly a LUKS-encrypted device.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{\texttt{dm-crypt}}
		\begin{itemize}
		\item No metadata on-disk.
		\item No key-stretching.
		\item Just mappings!
		\item Re-specify all parameters precisely or get garbage.
		\item Encrypted device, or wiped device?
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Multiple Layers}
		\begin{itemize}
		\item Why rely on one cipher that may get cracked?
		\item Make a mapping over the mapping.
			\begin{itemize}
			\item Example: \texttt{/dev/mapper/root -> /dev/mapper/.extra\_layer -> /dev/sda}
			\end{itemize}
		\item Keep adding layers for more security.
		\end{itemize}
	\end{frame}

\section{Early Userspace}\label{section:hell}
	\begin{frame}
		\frametitle{Basics}
		\begin{itemize}
		\item Root filesystem encrypted, how can Linux mount it?
			\begin{itemize}
			\item Create "early userspace" environment to mount root filesystem.
			\end{itemize}
		\item Part of Linux boot process.
		\item Other uses:
			\begin{itemize}
			\item Load firmware.
			\item Mount root filesystem over NFS.
			\end{itemize}
		\item Documentation:
			\begin{itemize}
			\item \texttt{Documentation/early-userspace/README}
			\item \texttt{Documentation/init.txt}
			\item \texttt{Documentation/initrd.txt}
			\end{itemize}
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{\texttt{initramfs}}
		\begin{itemize}
		\item \texttt{initramfs} contains Early-userspace environment.
		\item Successor to \texttt{initrd}.
		\item Gzipped CPIO archive.
			\begin{itemize}
			\item Magic command: \texttt{find . | cpio --quiet -H newc -o | gzip -9 -n > ../initramfs}
			\end{itemize}
		\item Contains initial root file system \& \texttt{init} script.
		\item Execute \texttt{init} script, which switches to actual root filesystem; early-userspace environment discarded.
		\item Support must be enable in kernel (\texttt{CONFIG\_BLK\_DEV\_INITRD)}.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Early-userspace Binaries}
		\begin{itemize}
		\item Simply copying binaries unlikely to work (\textit{dynamically-linked}).
			\begin{itemize}
			\item \texttt{ldd} shows dynamic-linking dependencies.
			\end{itemize}
		\item Copy all dependencies or make binaries \textit{statically-linked}.
		\item Statically-compiled binaries are \textit{huge}.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{\texttt{busybox}}
		\begin{itemize}
		\item Stripped-down Unix toolkit: \texttt{busybox}.
		\item Often used in embedded Linux systems.
		\item Easier than individually adding binaries such as \texttt{cp}, \texttt{ls}, \texttt{rm}, \&c.
		\item Install built-in binaries: \texttt{busybox --install -s}.
		\item Uses different, basic shells; certain \texttt{bash} features unsupported (ex: arrays).
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{\texttt{init}}
		\begin{itemize}
		\item Does ``whatever'' needs to be done.
		\item May be a binary or a script.
		\item Will receive same arguments as the kernel.
		\item Easy method: find one on the Internet and study/copy it!
		\item Failure will result in a kernel panic.
		\end{itemize}
	\end{frame}

	\begin{frame}
		\frametitle{Summary}
		\begin{itemize}
		\item Create directory structure for \texttt{initramfs}.
		\item Copy statically-linked binaries, or dynamically-linked binaries with dependenices.
		\item Write \texttt{init} script.
		\item Create a Gzipped CPIO archive:
			\begin{itemize}
			\item \texttt{find . | cpio --quiet -H newc -o | gzip -9 -n > ../initramfs}
			\end{itemize}
		\item Add \texttt{initramfs=</path/to/initramfs>} kernel argument or build it into the kernel.
		\end{itemize}
	\end{frame}

	%TODO: "Fun" visualization.

% References.
\section{References}
\begin{frame}
	\frametitle{References}
	\begin{itemize}
	\item Thorough FAQ: https://code.google.com/p/cryptsetup/wiki/FrequentlyAskedQuestions
	\item Your local distro's Wiki for specifics.
	\item Linux Documentation under \texttt{Documentation/}.
	\item \texttt{man} pages.
	\end{itemize}
\end{frame}

\end{document}

